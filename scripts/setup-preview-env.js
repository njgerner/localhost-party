#!/usr/bin/env node
/**
 * Setup Preview Environment Variables
 *
 * This script runs before the Vercel build to configure the WebSocket URL
 * for preview environments. It constructs the Railway preview URL based on
 * the PR number.
 *
 * Railway Preview URL Pattern:
 *   https://localhost-party-ws-pr-{PR_NUMBER}.up.railway.app
 *
 * Environment Variables Used:
 *   - VERCEL_ENV: 'production' | 'preview' | 'development'
 *   - VERCEL_GIT_PULL_REQUEST_ID: PR number (only in preview)
 *   - RAILWAY_SERVICE_NAME: Name of the Railway service (optional)
 */

const fs = require("fs");
const path = require("path");

// Railway service configuration
const RAILWAY_SERVICE_NAME = process.env.RAILWAY_SERVICE_NAME || "localhost-party-ws";
const RAILWAY_DOMAIN = "up.railway.app";

function getWebSocketUrl() {
  const vercelEnv = process.env.VERCEL_ENV;
  const prNumber = process.env.VERCEL_GIT_PULL_REQUEST_ID;

  // Production: Use the configured production WebSocket URL
  if (vercelEnv === "production") {
    const prodUrl = process.env.NEXT_PUBLIC_LH_PARTY_WS_URL;
    if (prodUrl) {
      console.log(`[Preview Setup] Production environment - using configured URL: ${prodUrl}`);
      return prodUrl;
    }
    console.log("[Preview Setup] Production environment - no WS URL configured");
    return null;
  }

  // Preview: Construct Railway preview URL from PR number
  if (vercelEnv === "preview" && prNumber) {
    const previewUrl = `https://${RAILWAY_SERVICE_NAME}-pr-${prNumber}.${RAILWAY_DOMAIN}`;
    console.log(`[Preview Setup] Preview environment (PR #${prNumber}) - WebSocket URL: ${previewUrl}`);
    return previewUrl;
  }

  // Development or unknown: Use localhost
  if (vercelEnv === "development" || !vercelEnv) {
    console.log("[Preview Setup] Development environment - using localhost:3000");
    return "http://localhost:3000";
  }

  console.log(`[Preview Setup] Unknown environment: ${vercelEnv}`);
  return null;
}

function writeEnvFile(wsUrl) {
  if (!wsUrl) {
    console.log("[Preview Setup] No WebSocket URL to write");
    return;
  }

  // Write to .env.local which Next.js will pick up
  const envPath = path.join(process.cwd(), ".env.local");
  const envContent = `# Auto-generated by setup-preview-env.js
# Do not edit manually - this file is overwritten during builds
NEXT_PUBLIC_LH_PARTY_WS_URL=${wsUrl}
`;

  // Append to existing .env.local or create new
  if (fs.existsSync(envPath)) {
    const existing = fs.readFileSync(envPath, "utf8");
    // Remove any existing NEXT_PUBLIC_LH_PARTY_WS_URL line
    const filtered = existing
      .split("\n")
      .filter((line) => !line.startsWith("NEXT_PUBLIC_LH_PARTY_WS_URL="))
      .join("\n");
    fs.writeFileSync(envPath, filtered + "\n" + `NEXT_PUBLIC_LH_PARTY_WS_URL=${wsUrl}\n`);
  } else {
    fs.writeFileSync(envPath, envContent);
  }

  console.log(`[Preview Setup] Written WebSocket URL to ${envPath}`);
}

function main() {
  console.log("\n========================================");
  console.log("  Preview Environment Setup");
  console.log("========================================");
  console.log(`VERCEL_ENV: ${process.env.VERCEL_ENV || "(not set)"}`);
  console.log(`VERCEL_GIT_PULL_REQUEST_ID: ${process.env.VERCEL_GIT_PULL_REQUEST_ID || "(not set)"}`);
  console.log(`VERCEL_GIT_COMMIT_REF: ${process.env.VERCEL_GIT_COMMIT_REF || "(not set)"}`);
  console.log("----------------------------------------\n");

  const wsUrl = getWebSocketUrl();

  // Only write env file for preview environments
  // Production and dev should use Doppler/Vercel configured values
  if (process.env.VERCEL_ENV === "preview") {
    writeEnvFile(wsUrl);
  }

  console.log("\n========================================\n");
}

main();
